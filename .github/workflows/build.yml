name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build Helper
      run: |
        xcodebuild -project AWDLControl/AWDLControl.xcodeproj \
                   -target AWDLControlHelper \
                   -configuration Release \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   -quiet
        # Verify binary was created
        ls -la AWDLControl/build/Release/AWDLControlHelper

    - name: Build Swift App and Widget
      run: |
        xcodebuild -project AWDLControl/AWDLControl.xcodeproj \
                   -target AWDLControl \
                   -target AWDLControlWidget \
                   -configuration Release \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   -quiet

    - name: Verify Build Artifacts
      run: |
        echo "Checking helper binary..."
        ls -la "AWDLControl/build/Release/AWDLControlHelper"

        echo "Checking app bundle..."
        ls -la "AWDLControl/build/Release/Ping Warden.app" || echo "App bundle not found at expected location"

        echo "Checking widget extension..."
        ls -la "AWDLControl/build/Release/Ping Warden.app/Contents/PlugIns/AWDLControlWidget.appex" 2>/dev/null || echo "Widget not embedded (expected for unsigned build)"

        echo "Build completed successfully!"
