name: Build Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Note: This workflow verifies the code compiles but does not produce
# a distributable app. For distribution builds, use build.sh on a Mac
# with a valid Developer ID certificate installed.

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build Helper (verification only)
      run: |
        echo "Building AWDLControlHelper..."
        xcodebuild -project AWDLControl/AWDLControl.xcodeproj \
                   -target AWDLControlHelper \
                   -configuration Release \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   ONLY_ACTIVE_ARCH=NO \
                   -quiet
        echo "Helper binary built successfully"
        ls -la AWDLControl/build/Release/AWDLControlHelper

    - name: Build App (verification only)
      run: |
        echo "Building AWDLControl app..."
        # Note: Widget is skipped in CI as it requires App Groups entitlement
        # which needs a valid signing certificate
        xcodebuild -project AWDLControl/AWDLControl.xcodeproj \
                   -target AWDLControl \
                   -configuration Release \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   ONLY_ACTIVE_ARCH=NO \
                   -quiet
        echo "App built successfully"

    - name: Verify Build Artifacts
      run: |
        echo "=== Build Verification Results ==="
        echo ""

        echo "Helper binary:"
        ls -la "AWDLControl/build/Release/AWDLControlHelper"
        file "AWDLControl/build/Release/AWDLControlHelper"
        echo ""

        echo "App bundle:"
        ls -la "AWDLControl/build/Release/Ping Warden.app" || ls -la AWDLControl/build/Release/*.app
        echo ""

        echo "App bundle contents:"
        ls -la "AWDLControl/build/Release/Ping Warden.app/Contents/MacOS/" || true
        echo ""

        echo "=== Build verification passed ==="
        echo ""
        echo "Note: This is a CI verification build without code signing."
        echo "For a distributable app, build locally with a Developer ID certificate."
